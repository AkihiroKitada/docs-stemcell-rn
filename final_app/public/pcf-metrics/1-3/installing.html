<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <!-- Always force latest IE rendering engine or request Chrome Frame -->
  <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">

  <link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,300italic,400italic,400,600' rel='stylesheet' type='text/css'>
  <!-- Use title if it's in the page YAML frontmatter -->
  <title>
      Installing PCF Metrics |
    Pivotal Docs
  </title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="/stylesheets/all.css" rel="stylesheet" media="screen, print" />
  <link href="/stylesheets/print.css" rel="stylesheet" media="print" />
  <link href='/images/favicon.ico' rel='shortcut icon'>

  <script src="/javascripts/all.js"></script>
  
<script type="text/javascript">
  if (window.location.host === 'docs.pivotal.io') {
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-39702075-1']);
    _gaq.push(['_setDomainName', 'pivotal.io']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script');
      ga.type = 'text/javascript';
      ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0];
      s.parentNode.insertBefore(ga, s);
    })();
  }
</script>

<script type="text/javascript">
  var blackList = ['acceptance'];

  blackList.forEach(function(blackListedEnv) {
    if (document.URL.indexOf(blackListedEnv) > -1 && blackListedEnv != "") {
      $('head').append('<meta name="hashtag" content="PivotalMoment">');
    }
  });
</script>

<!-- CrazyEgg Tracking Script -->
  <script type="text/javascript">
  setTimeout(function(){var a=document.createElement("script");
  var b=document.getElementsByTagName("script")[0];
  a.src=document.location.protocol+"//script.crazyegg.com/pages/scripts/0055/2990.js?"+Math.floor(new Date().getTime()/3600000);
  a.async=true;a.type="text/javascript";b.parentNode.insertBefore(a,b)}, 1);
  </script>

<!-- Munchkin Marketo Script -->
<script type="text/javascript">
  (function() {
    var didInit = false;

    function initMunchkin() {
      if (didInit === false) {
        didInit = true;
        Munchkin.init('625-IUJ-009');
      }
    }

    var s = document.createElement('script');
    s.type = 'text/javascript';
    s.async = true;
    s.src = document.location.protocol + '//munchkin.marketo.net/munchkin.js';
    s.onreadystatechange = function() {
      if (this.readyState == 'complete' || this.readyState == 'loaded') {
        initMunchkin();
      }
    };
    s.onload = initMunchkin;
    document.getElementsByTagName('head')[0].appendChild(s);
  })();
</script>

</head>

<body class="pcf-metrics pcf-metrics_1-3 pcf-metrics_1-3_installing has-subnav">

<div class="viewport">
  <div class='wrap'>
    <script type="text/javascript">
      document.domain = "pivotal.io";
    </script>

      <header class="global-header header header-layout js-bar-links">
    <a class="pivotal-logo" href="/">
    </a>
    <a href="/" class="global-header-title">
      <span class="title-deemph">Pivotal</span> Documentation
    </a>
    <div class="btn-menu" data-behavior="MenuMobile"></div>
    <div class="header-links">
      <div class="header-item">
        <a href="https://network.pivotal.io/">Downloads</a>
      </div>
      <div class="header-item">
        <a href="http://support.pivotal.io" target="_blank">Support</a>
      </div>

      <div class="header-item embedded-searchbar">
          <form method="get" action="/search">
            <input name="q" placeholder="Search PCF Metrics 1.3" class="search-box" />
              <input type="hidden" name="product_name" value="PCF Metrics" />
              <input type="hidden" name="product_version" value="1.3"/>
          </form>
      </div>
      
    </div>
  </header>



    <div class="container">

      <!--googleoff: index-->
      <div id="sub-nav" class="js-sidenav nav-container" role="navigation">
  <a class="sidenav-title" data-behavior="SubMenuMobile">
    Doc Index
  </a>
  <div class="nav-content">
    <ul>
      <li>
        <a id='home-nav-link' href="/pcf-metrics/1-3/index.html">Pivotal Cloud Foundry Metrics</a>
      </li>

      <li>
        <a href="/pcf-metrics/1-3/installing.html">Installing PCF Metrics</a>
      </li>

      <li>
        <a href="/pcf-metrics/1-3/sizing.html">Sizing PCF Metrics for Your System</a>
      </li>

      <li>
        <a href="/pcf-metrics/1-3/using.html">Monitoring and Troubleshooting Apps with PCF Metrics</a>
      </li>

      <li>
        <a href="/pcf-metrics/1-3/troubleshooting.html">Troubleshooting PCF Metrics</a>
      </li>

      <li>
        <a href="/pcf-metrics/1-3/architecture.html">PCF Metrics Product Architecture</a>
      </li>

      <li>
        <a href="/pcf-metrics/1-3/rn-ki.html">Release Notes and Known Issues</a>
      </li>

    </ul>
  </div>
</div><!--end of sub-nav-->

      <!--googleon: index-->

      <main class="content content-layout" id="js-content" role="main">
        <a id="top"></a>
          <div class="local-header title-container">
    <div class="local-header version-info">
      LATEST VERSION: 1.4 - <a href="">CHANGELOG</a>
    </div>
    <div class="local-header local-title clearfix">
      <img src="/images/cloud_rings.png">
      <span class="local-header-title">PCF Metrics
      </span>
      <span class="local-header local-version header-dropdown">
        <a class="local-header header-dropdown-link">v1.3</a>
        <span class="local-header header-dropdown-content">
          <ul>
                <li>
                    <a href="http://docs.pivotal.io/pcf-metrics/1-4/installing.html">v1.4</a>
                </li>
                <li>
                    <a href="http://docs.pivotal.io/pcf-metrics/1-2/installing.html">v1.2</a>
                </li>
                <li>
                    <a href="http://docs.pivotal.io/pcf-metrics/1-1/installing.html">v1.1</a>
                </li>
                <li>
                    <a href="http://docs.pivotal.io/pcf-metrics/1-0/installing.html">v1.0</a>
                </li>
          </ul>
        </span>
      </span>

      <!-- search was here -->
    </div>
    <div class="local-header local-header-links">
    </div>
  </div>

          <h1 class="title-container" >
    Installing PCF Metrics
  </h1>

          <div id="js-quick-links" class="list-style-none">
            <div class="quick-links"><ul>
<li><a href="#pre-reqs">Prerequisites</a></li>
<li><a href="#step1">Step 1: Add the PCF Metrics Tile to Ops Manager</a></li>
<li><a href="#step2">Step 2: Configure the PCF Metrics Tile</a></li>
<li><a href="#step3">Step 3: Configure the Temporary Datastore</a></li>
<li><a href="#step4">Step 4: Deploy PCF Metrics</a></li>
</ul></div>
          </div>
        <div class="to-top" id="js-to-top">
          <a href="#top" title="back to top"></a>
        </div>
        <p>This document describes how to install and configure Pivotal Cloud Foundry (PCF) Metrics.</p>

<p>For information about the components deployed as part of this install procedure, see the <a href="/pcf-metrics/1-3/architecture.html">PCF Metrics Product Architecture</a> topic.</p>

<h2><a id='pre-reqs'></a>Prerequisites</h2>

<ul>
<li>Ensure that you have installed the <a href="http://docs.pivotal.io/pivotalcf/installing/index.html">Elastic Runtime Tile</a>.</li>
<li>Ensure that you have installed v1.6 or later of the <a href="https://docs.pivotal.io/redis/1-6/">Redis tile</a>.</li>
<li>If you are running PCF on AWS, then ensure that, in Elastic Runtime, you have changed the <strong>Loggregator Port</strong> to <code>4443</code>from its value of <code>443</code>.</li>
<li>If you are running PCF on Google Cloud Platform (GCP), then do the following to configure the DNS entries to 
accommodate web sockets:

<ol>
<li>Log in to the GCP console.</li>
<li>In the menu, navigate to the <strong>Networking</strong> tab and click <strong>Load Balancing</strong>.</li>
<li>Find the load balancer that corresponds to <code>ENVIRONMENT-cf-ws</code>.</li>
<li>Record the IP address.</li>
<li>Click <strong>Cloud DNS</strong>, then click <strong>ENVIRONMENT-zone</strong>.</li>
<li>Click <strong>Add Record Set</strong>.</li>
<li>Enter a DNS name for mysql-logqueue. The DNS name should be <code>mysql-logqueue.SYSTEM_DOMAIN</code>.  Refer to your ERT Tile&rsquo;s configuration of the System Domain under the Domains configuration section.</li>
<li>In the IPv4 address field, enter the IP address of the load balancer that you recorded in Step 4.</li>
<li>Leave the other fields as default.</li>
<li>Repeat Steps 6â€“9 twice to create DNS records for elasticsearch-logqueue (<code>elasticsearch-logqueue.SYSTEM_DOMAIN</code>) and metrics (<code>metrics.SYSTEM_DOMAIN</code>).</li>
</ol></li>
</ul>

<h2><a id='step1'></a> Step 1: Add the PCF Metrics Tile to Ops Manager</h2>

<p><p class='note'><strong>Note</strong>: PCF Metrics should be installed on the same network as the Elastic Runtime Tile. </p></p>

<ol>
<li>Download the PCF Metrics file from
<a href="https://network.pivotal.io/products/pcf-metrics">Pivotal Network</a>.</li>
<li>Upload the PCF Metrics file to your Ops Manager installation.</li>
<li>Click <strong>Add</strong> next to the uploaded product description in the <strong>Available Products</strong>
view to add PCF Metrics to your <strong>Installation Dashboard</strong>.</li>
</ol>

<h2><a id='step2'></a>Step 2: Configure the PCF Metrics Tile</h2>

<p class="note"><strong>Note</strong>: The following procedures offer a standard configuration. To customize PCF Metrics for high capacity, see the <a href="sizing.html">Sizing PCF Metrics For Your System</a> topic.</p>

<p>From the <strong>Installation Dashboard</strong>, click the <strong>PCF Metrics</strong> tile.</p>

<h3>Assign Availability Zones (AZs) and Networks.</h3>

<ol>
<li>Click <strong>Assign AZs and Networks</strong>.</li>
<li>Select an Availability Zone under <strong>Place singleton jobs</strong>.
<br>
Ops Manager runs Metrics jobs with a single instance in this Availability Zone.</li>
<li>Select one or more Availability Zones under <strong>Balance other jobs</strong>.
<br>
Ops Manager balances instances of Metrics jobs with more than one instance
across the Availability Zones that you specify.</li>
<li>Use the drop-down menu to select a network.</li>
<li>Click <strong>Save</strong>.</li>
</ol>

<h4>Data Services Ports</h4>

<p>For reference, the following table shows the port associated with each data service.
<table border="1" class="nice">
  <thead>
    <tr>
      <th>Service</th>
      <th>Port</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Elasticsearch</td>
      <td>9200</td>
    </tr>
    <tr>
      <td>MySQL</td>
      <td>3306</td>
    </tr>
  </tbody>
</table></p>

<h3><a name="alerts"></a> MySQL Alerts</h3>

<ol>
<li>Click <strong>MySQL Alerts</strong>.</li>
<li>Set the <strong>Email</strong> value. Alerts for issues storing metrics into the MySQL cluster will be sent to this email address.</li>
</ol>

<h3><a name="data"></a> Data Store</h3>

<ol>
<li>Click <strong>Data Store</strong> ( Only for PCF Metrics <strong>1.3.4 and lower</strong>)</li>
<li>Review the <strong>Elastic Search Heap Size</strong> value. Elastic Search memory allocation for Heap use. Set to 50% of the memory allocated to the smallest of the Elasticsearch instances in Resource Config or 31GB, whichever is smaller. Use a unit of M for megabytes or G for gigabytes.</li>
<li>Review the <strong>MySQL InnoDB Buffer Size</strong> value. Set to 80% of MySQL Server VM memory. Use a unit of M for megabytes or G for gigabytes.</li>
<li>Review the <strong>MySQL Logqueue Count</strong> value. You can increase this instance count at any time to accommodate higher levels of inbound metrics traffic. </li>
<li>Review the <strong>Elasticsearch Logqueue Count</strong> value. You can increase this instance count at any time to accommodate higher levels of inbound log traffic. </li>
<li>Review the <strong>Ingestor Count</strong> value. You can increase this instance count at any time to accommodate higher levels of Loggregator Firehose traffic. </li>
<li>Click <strong>Save</strong>.</li>
</ol>

<h3><a name="errands"></a> Errands</h3>

<p>To properly configure the <strong>Errands</strong> pane, follow the procedure that corresponds to your Ops Manager version. </p>

<h4>Ops Manager v1.9</h4>

<ol>
<li>Click <strong>Errands</strong>.
<p class="note"><strong>Note:</strong> The PCF Metrics tile selects all <strong>Post-Deploy Errands</strong> by default. Pivotal recommends that you do not deselect any errands as doing so can cause issues with the deployment of the tile. However, you can deselect the <b>Remove Legacy PCF Metrics CF Resources</b> errand after deploying v1.3 of the tile.</p></li>
<li><p>Review the <strong>Post-Deploy Errands</strong> and <strong>Pre-Delete Errands</strong>:</p>

<ol>
<li><p>If you are deploying the tile for the first time, select all <strong>Post-Deploy Errands</strong>.</p>

<ul>
<li>The following list describes what the <strong>Smoke tests</strong> errand does. For information about resolving errors discovered by this errand, 
see the <a href="/pcf-metrics/1-3/troubleshooting.html#smoke-test">Smoke Test Errors</a> section of the <em>Troubleshooting PCF Metrics</em> topic.

<ul>
<li>Confirms that MySQL ingests metrics</li>
<li>Confirms that Elasticsearch ingests logs</li>
<li>Confirms that the APIs return metrics and logs</li>
</ul></li>
</ul>

<p class="note"><strong>Note</strong>: If you deselect <strong>Remove PCF Metrics 1.3 CF Resources</strong> under <strong>Pre-Delete Errands</strong>, artifacts may remain after the PCF Metrics tile uninstalls.</p></li>
</ol></li>
</ol>

<h4>Ops Manager 1.10 and up</h4>

<ol>
<li><p>Click <strong>Errands</strong>.
<p class="note warning"><strong>WARNING</strong>: By default, The PCF Metrics tile sets all <strong>Post-Deploy Errands</strong> to only run when changed. You must make the configuration changes below for the first deployment of the PCF Metrics tile to succeed.</p></p></li>
<li><p>Review the <strong>Post-Deploy Errands</strong> and <strong>Pre-Delete Errands</strong>:</p>

<ol>
<li>If you are deploying the tile for the first time, set <strong>Post-Deploy Errands</strong> to <strong>On</strong>.</li>
<li><p>For deployments after the initial install, configure the <strong>Post-Deploy Errands</strong> as follows:</p>

<ol>
<li>Set <strong>Remove Legacy PCF Metrics CF Resources</strong> to <strong>When Changed</strong></li>
<li>Set <strong>Remove PCF Metrics 1.2 CF Resources</strong> to <strong>When Changed</strong></li>
<li>Set <strong>Push PCF Metrics components</strong> to <strong>On</strong></li>
<li>Set <strong>Smoke tests for Metrics Data and Apm</strong> to <strong>On</strong>

<ul>
<li>The following list describes what the <strong>Smoke tests</strong> errand does. For information about resolving errors discovered by this errand, 
see the <a href="/pcf-metrics/1-3/troubleshooting.html#smoke-test">Smoke Test Errors</a> section of the <em>Troubleshooting PCF Metrics</em> topic.

<ul>
<li>Confirms that MySQL ingests metrics</li>
<li>Confirms that Elasticsearch ingests logs</li>
<li>Confirms that the APIs return metrics and logs</li>
</ul></li>
</ul></li>
</ol>

<p class="note"><strong>Note</strong>: If you set <strong>Remove PCF Metrics 1.3 CF Resources</strong> under <strong>Pre-Delete Errands</strong> to <strong>Off</strong>, artifacts may remain after the PCF Metrics tile uninstalls.</p></li>
</ol></li>
</ol>

<h3><a name="resource-config"></a> Resource Config</h3>

<p><strong>Only for PCF Metrics **1.3.4 and lower</strong>, as we removed few extraneous VMs from this list, Refer to 1.3.5 release notes and resource config for more details.
1. Click <strong>Resource Config</strong>.
1. Review the resource configurations. By default, the settings match the instance types that are best suited for each job. For reference, the following table shows the default resource and IP requirements for installing the PCF Metrics tile: 
  <p class="note"><strong>Note</strong>: The actual default values you will see in your PCF Metrics tile will depend on the available resources for your PCF deployment. Refer to <a href="/pcf-metrics/1-3/sizing.html#metrics-considerations">Sizing PCF Metrics For Your System</a> to correctly configure Metrics resources for your deployment.</p>
  <table border="1" class="nice">
    <thead>
    <tr>
      <th>Resource</th>
      <th>Instances</th>
      <th>Persistent</th>
      <th>CPU</th>
      <th>RAM</th>
      <th>Ephemeral</th>
      <th>Static IP</th>
      <th>Dynamic IP</th>
    </tr>
    </thead>
    <tbody>
    <tr>
      <td>Elasticsearch Master</td>
      <td>3</td>
      <td>10&nbsp;GB</td>
      <td>4</td>
      <td>16&nbsp;GB</td>
      <td>32&nbsp;GB</td>
      <td>3</td>
      <td>0</td>
    </tr>
    <tr>
      <td>Elasticsearch Coordinator</td>
      <td>2</td>
      <td>1&nbsp;GB</td>
      <td>2</td>
      <td>16&nbsp;GB</td>
      <td>32&nbsp;GB</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <td>Elasticsearch Data</td>
      <td>4</td>
      <td>100&nbsp;GB</td>
      <td>2</td>
      <td>16&nbsp;GB</td>
      <td>32&nbsp;GB</td>
      <td>4</td>
      <td>0</td>
    </tr>
    <tr>
      <td>MySQL Server</td>
      <td>2</td>
      <td>100&nbsp;GB</td>
      <td>2</td>
      <td>16&nbsp;GB</td>
      <td>32&nbsp;GB</td>
      <td>3</td>
      <td>0</td>
    </tr>
    <tr>
      <td>MySQL Proxy</td>
      <td>2</td>
      <td><em>n/a</em></td>
      <td>2</td>
      <td>16&nbsp;GB</td>
      <td>32&nbsp;GB</td>
      <td>2</td>
      <td>0</td>
    </tr>
    <tr>
      <td>MySQL Monitor</td>
      <td>1 (not configurable)</td>
      <td><em>n/a</em></td>
      <td>2</td>
      <td>16&nbsp;GB</td>
      <td>32&nbsp;GB</td>
      <td>0</td>
      <td>1</td>
    </tr>
    <tr>
      <td>Metron</td>
      <td>1 (not configurable)</td>
      <td><em>n/a</em></td>
      <td>2</td>
      <td>4&nbsp;GB</td>
      <td>32&nbsp;GB</td>
      <td>1</td>
      <td>0</td>
    </tr>
    </tbody>
  </table></p>
<pre class="highlight plaintext"><code>If you expect a high level of use, you may need to increase the disk resources available to your instances. For information about sizing, see [Sizing PCF Metrics For Your System](./sizing.html).

&lt;p class="note"&gt;&lt;strong&gt;Note:&lt;/strong&gt; There have been issues with the Ops Manager Bosh Director correctly partitioning persistent disks larger than 2&amp;nbsp;TB.&lt;/p&gt;
</code></pre>

<ol>
<li>Click <strong>Save</strong>.</li>
</ol>

<h3><a name="stemcell"></a> Stemcell</h3>

<ol>
<li>Navigate to <a href="https://network.pivotal.io">Pivotal Network</a> and click <strong>Stemcells</strong>.</li>
<li>Download the appropriate stemcell version for your IaaS.
<p class='note'><strong>Note:</strong> On AWS make sure to use a HVM stemcell if you are using the default instance sizes.</p></li>
<li>Click <strong>Import Stemcell</strong> and select the stemcell file you downloaded.</li>
</ol>

<h2><a id='step3'></a>Step 3: Configure the Temporary Datastore</h2>

<p>PCF Metrics uses a temporary datastore during Elasticsearch downtime, including upgrades, to significantly reduce log loss by continuing to store app logs from the Loggregator Firehose.</p>

<p>To configure the temporary datastore, follow the instructions in the <a href="/pcf-metrics/1-3/sizing.html#temp-datastore">Configuring the Temporary Datastore</a> section of <em>Sizing PCF Metrics for your System</em>. </p>

<h2><a id='step4'></a>Step 4: Deploy PCF Metrics</h2>

<p>Click <strong>Apply Changes</strong> to install the service. If the smoke tests fail, see the <a href="/pcf-metrics/1-3/troubleshooting.html#smoke-test">Troubleshoot Smoke Test Errors</a> section of the <em>Troubleshooting PCF Metrics</em> topic.</p>

<p>Review the <a href="/pcf-metrics/1-3/using.html">Monitoring and Troubleshooting Apps with PCF Metrics</a> topic for more information about how to log in, use, and interpret data from PCF Metrics.</p>

        <div><a id='repo-link' href='http://github.com/pivotal-cf/docs-metrics/tree/1.3/installing.html.md.erb'>View the source for this page in GitHub</a></div>

      </main>
    </div>
  </div>
</div>

<div id="scrim"></div>

<div class="container">
  <footer class="site-footer-links">
    <div class="copyright">
  <a href='https://pivotal.io/privacy-policy'>Privacy Policy</a> | 
  <a href='https://pivotal.io/terms-of-use'>Terms of Use</a><br/>
  <a href='/'>Pivotal Documentation</a>
  &copy; 2017 <a href='https://pivotal.io'>Pivotal Software</a>, Inc. All Rights Reserved.
</div>
<div class="support">
  Need help? <a href="http://support.pivotal.io" target="_blank">Visit Support</a>
</div>

  </footer>
</div><!--end of container-->

</body>
</html>
