<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <!-- Always force latest IE rendering engine or request Chrome Frame -->
  <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">

  <link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,300italic,400italic,400,600' rel='stylesheet' type='text/css'>
  <!-- Use title if it's in the page YAML frontmatter -->
  <title>
      Troubleshooting PCF Metrics |
    Pivotal Docs
  </title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="/stylesheets/all.css" rel="stylesheet" media="screen, print" />
  <link href="/stylesheets/print.css" rel="stylesheet" media="print" />
  <link href='/images/favicon.ico' rel='shortcut icon'>

  <script src="/javascripts/all.js"></script>
  
<script type="text/javascript">
  if (window.location.host === 'docs.pivotal.io') {
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-39702075-1']);
    _gaq.push(['_setDomainName', 'pivotal.io']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script');
      ga.type = 'text/javascript';
      ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0];
      s.parentNode.insertBefore(ga, s);
    })();
  }
</script>

<script type="text/javascript">
  var blackList = ['acceptance'];

  blackList.forEach(function(blackListedEnv) {
    if (document.URL.indexOf(blackListedEnv) > -1 && blackListedEnv != "") {
      $('head').append('<meta name="hashtag" content="PivotalMoment">');
    }
  });
</script>

<!-- CrazyEgg Tracking Script -->
  <script type="text/javascript">
  setTimeout(function(){var a=document.createElement("script");
  var b=document.getElementsByTagName("script")[0];
  a.src=document.location.protocol+"//script.crazyegg.com/pages/scripts/0055/2990.js?"+Math.floor(new Date().getTime()/3600000);
  a.async=true;a.type="text/javascript";b.parentNode.insertBefore(a,b)}, 1);
  </script>

<!-- Munchkin Marketo Script -->
<script type="text/javascript">
  (function() {
    var didInit = false;

    function initMunchkin() {
      if (didInit === false) {
        didInit = true;
        Munchkin.init('625-IUJ-009');
      }
    }

    var s = document.createElement('script');
    s.type = 'text/javascript';
    s.async = true;
    s.src = document.location.protocol + '//munchkin.marketo.net/munchkin.js';
    s.onreadystatechange = function() {
      if (this.readyState == 'complete' || this.readyState == 'loaded') {
        initMunchkin();
      }
    };
    s.onload = initMunchkin;
    document.getElementsByTagName('head')[0].appendChild(s);
  })();
</script>

</head>

<body class="pcf-metrics pcf-metrics_1-3 pcf-metrics_1-3_troubleshooting has-subnav">

<div class="viewport">
  <div class='wrap'>
    <script type="text/javascript">
      document.domain = "pivotal.io";
    </script>

      <header class="global-header header header-layout js-bar-links">
    <a class="pivotal-logo" href="/">
    </a>
    <a href="/" class="global-header-title">
      <span class="title-deemph">Pivotal</span> Documentation
    </a>
    <div class="btn-menu" data-behavior="MenuMobile"></div>
    <div class="header-links">
      <div class="header-item">
        <a href="https://network.pivotal.io/">Downloads</a>
      </div>
      <div class="header-item">
        <a href="http://support.pivotal.io" target="_blank">Support</a>
      </div>

      <div class="header-item embedded-searchbar">
          <form method="get" action="/search">
            <input name="q" placeholder="Search PCF Metrics 1.3" class="search-box" />
              <input type="hidden" name="product_name" value="PCF Metrics" />
              <input type="hidden" name="product_version" value="1.3"/>
          </form>
      </div>
      
    </div>
  </header>



    <div class="container">

      <!--googleoff: index-->
      <div id="sub-nav" class="js-sidenav nav-container" role="navigation">
  <a class="sidenav-title" data-behavior="SubMenuMobile">
    Doc Index
  </a>
  <div class="nav-content">
    <ul>
      <li>
        <a id='home-nav-link' href="/pcf-metrics/1-3/index.html">Pivotal Cloud Foundry Metrics</a>
      </li>

      <li>
        <a href="/pcf-metrics/1-3/installing.html">Installing PCF Metrics</a>
      </li>

      <li>
        <a href="/pcf-metrics/1-3/sizing.html">Sizing PCF Metrics for Your System</a>
      </li>

      <li>
        <a href="/pcf-metrics/1-3/using.html">Monitoring and Troubleshooting Apps with PCF Metrics</a>
      </li>

      <li>
        <a href="/pcf-metrics/1-3/troubleshooting.html">Troubleshooting PCF Metrics</a>
      </li>

      <li>
        <a href="/pcf-metrics/1-3/architecture.html">PCF Metrics Product Architecture</a>
      </li>

      <li>
        <a href="/pcf-metrics/1-3/rn-ki.html">Release Notes and Known Issues</a>
      </li>

    </ul>
  </div>
</div><!--end of sub-nav-->

      <!--googleon: index-->

      <main class="content content-layout" id="js-content" role="main">
        <a id="top"></a>
          <div class="local-header title-container">
    <div class="local-header version-info">
      LATEST VERSION: 1.4 - <a href="">CHANGELOG</a>
    </div>
    <div class="local-header local-title clearfix">
      <img src="/images/cloud_rings.png">
      <span class="local-header-title">PCF Metrics
      </span>
      <span class="local-header local-version header-dropdown">
        <a class="local-header header-dropdown-link">v1.3</a>
        <span class="local-header header-dropdown-content">
          <ul>
                <li>
                    <a href="http://docs.pivotal.io/pcf-metrics/1-4/troubleshooting.html">v1.4</a>
                </li>
                <li>
                    <a href="http://docs.pivotal.io/pcf-metrics/1-2/troubleshooting.html">v1.2</a>
                </li>
                <li>
                    <a href="http://docs.pivotal.io/pcf-metrics/1-1/troubleshooting.html">v1.1</a>
                </li>
                <li>
                    <a href="http://docs.pivotal.io/pcf-metrics/1-0/troubleshooting.html">v1.0</a>
                </li>
          </ul>
        </span>
      </span>

      <!-- search was here -->
    </div>
    <div class="local-header local-header-links">
    </div>
  </div>

          <h1 class="title-container" >
    Troubleshooting PCF Metrics
  </h1>

          <div id="js-quick-links" >
            <div class="quick-links"><ul>
<li>
<a href="#deployment">Errors during Deployment</a><ul>
<li><a href="#smoke-test">Smoke Test Errors</a></li>
<li><a href="#es-no-start">Elasticsearch Instance does not Start</a></li>
</ul>
</li>
<li><a href="#ui">No Logs or Metrics in the UI</a></li>
<li><a href="#mysql">MySQL Node Failure</a></li>
<li><a href="#mysql-sst">MySQL SST Disabled Error</a></li>
<li><a href="#log">Log Errors</a></li>
<li><a href="#503">503 Errors</a></li>
<li><a href="#fetch-apps">Failed to Fetch Apps</a></li>
</ul></div>
          </div>
        <div class="to-top" id="js-to-top">
          <a href="#top" title="back to top"></a>
        </div>
        <p>This topic describes how to resolve common issues experienced while operating or using Pivotal Cloud Foundry (PCF) Metrics.</p>

<h2><a id="deployment"></a> Errors during Deployment</h2>

<p>The following sections describe errors that cause failure during a PCF Metrics tile and how to troubleshoot them. </p>

<h3><a id='smoke-test'></a> Smoke Test Errors</h3>

<p>PCF Metrics runs a set of smoke tests during installation to confirm system health.
If the smoke tests discover any errors, you can find a summary of those errors at the end of the errand log output,
including detailed logs about where the failure occurred. </p>

<p>The following tables describe common failures and how to resolve them.</p>

<h4>Insufficient Resources</h4>

<table border='1' class='nice'>
<tr>
  <th width="22%">Error</th>
  <td><code>Insufficient Resources</code>
  </td>
</tr>
<tr>
  <th>Cause</th>
  <td>Your PCF deployment has insufficient Diego resources to handle the apps pushed as part of a PCF Metrics installation. 
  <br><br>
  The PCF Metrics tile deploys the following apps:
  <table>
    <tr>
      <th>App</th>
      <th>Memory</th>
      <th>Disk</th>
    </tr>
    <tr>
      <td><code>metrics-ingestor</code><sup>*</sup></td>
      <td>512MB</td>
      <td>1GB</td>
    </tr>
    <tr>
      <td><code>mysql-logqueue</code><sup>*</sup></td>
      <td>1GB</td>
      <td>1GB</td>
    </tr>
    <tr>
      <td><code>elasticsearch-logqueue</code><sup>*</sup></td>
      <td>512MB</td>
      <td>1GB</td>
    </tr>
    <tr>
      <td><code>metrics-aggregator</code></td>
      <td>256MB</td>
      <td>1GB</td>
    </tr>
    <tr>
      <td><code>metrics</code></td>
      <td>1GB</td>
      <td>1GB</td>
    </tr>
    <tr>
      <td><code>worker-app-dev</code></td>
      <td>1GB</td>
      <td>1GB</td>
    </tr>
    <tr>
      <td><code>worker-app-logs</code></td>
      <td>1GB</td>
      <td>1GB</td>
    </tr>
    <tr>
      <td><code>worker-health-check</code></td>
      <td>1GB</td>
      <td>1GB</td>
    </tr>
    <tr>
      <td><code>worker-reaper</code></td>
      <td>1GB</td>
      <td>1GB</td>
    </tr>
  </table>
  
   <sup>*</sup>You may have more than one instance of each of the Ingestor and Loqueue apps depending your <a href="./sizing.html">sizing</a> needs. 
   You configure these instance counts as part of the <a href="./installing.html#data">Data Store</a> pane of the tile.</p></td></td>
</tr>
<tr>
  <th>Solution</th>
  <td>Increase the number of Diego cells so that your PCF deployment can support the apps pushed as part of the PCF Metrics installation:
  <br>
  <br>
  <ol>
  <li>Navigate to the <b>Resource Config</b> section of the Elastic Runtime tile.</li>
  <li>In the <b>Diego Cell</b> row, add another <b>Instance</b>.</li> 
  </ol>
</tr>
</table>

<h4>Nginx Load Balancer</h4>

<table border='1' class='nice'>
<tr>
  <th width="22%">Error</th>
  <td>The Smoke tests for Metrics UI errand failed.  <br>Or, the <strong>Smoke tests for Metrics UI</strong> checkbox is not selected and installation was successful, but the UI keeps loading and the graphs do not populate with data.</td>
</tr>
<tr>
  <th>Cause</th>
  <td>The Nginx <code>proxy_buffering</code> property is on and causes Nginx to block SSE traffic.</td>
</tr>
<tr>
  <th>Solution</th>
  <td>
    <ol>
      <li>From the cf CLI, target the <code>system</code> org and <code>metrics-v1-3</code> space of your PCF deployment:</li>
    <pre class="terminal">$ cf target -o system -s metrics-v1-3</pre>
      <li>
        Confirm that <strong>Smoke tests for Metrics UI</strong> errand was not run during installation by listing
        recent logs from the <code>worker-app-logs</code> and <code>worker-app-dev</code> apps:
        <pre class="terminal">$ cf logs --recent worker-app-logs <br>$ cf logs --recent worker-app-dev</pre>
        If neither log contains the text <code>jobStarted</code>, then the jobs are not queued because Nginx is blocking SSEs.
      </li>
      <li>Turn off the Nginx <code>proxy_buffering</code> property.</li>
    </ol>
  </td>
</tr>
</table>

<h4>Failed querying mysql</h4>

<table border='1' class='nice'>
<tr>
  <th width="22%">Error</th>
  <td><code>Failed querying mysql</code>
  </td>
</tr>
<tr>
  <th>Cause</th>
  <td>The tile deployed without the necessary errands selected to keep the internal database schema in sync with apps.</td>
</tr>
<tr>
  <th>Solution</th>
  <td>Re-deploy the tile with the following errands selected: 
  <ul>
    <li>
      <b>Database migrations for PCF Metrics</b>
    </li>
    <li>
      <b>Push PCF Metrics Data components</b>
    </li>
    <li>
      <b>Push PCF Metrics UI component</b>
    </li>
  </ul>
  </td>
</tr>
</table>

<h4>Received no results back from mysql - failing</h4>

<table border='1' class='nice'>
<tr>
  <th width="22%">Error</th>
  <td><code>Received no results back from mysql - failing</code>
  </td>
</tr>
<tr>
  <th>Cause</th>
  <td>The Ingestor is not functioning properly.</td>
</tr>
<tr>
  <th>Solution</th>
  <td>
  <ol>
  <li>From the cf CLI, target the <code>system</code> org and <code>metrics-v1-3</code> space of your PCF deployment:</li>
    <pre class="terminal">$ cf target -o system -s metrics-v1-3</pre>
    <li>Run <code>cf apps</code> to see if these apps are running:
      <ul>
        <li><code>metrics-ingestor</code></li>
        <li><code>mysql-logqueue</code></li>
      </ul>
    </li>
    <li>
      If the apps are not running, run the following commands to start them:
    </li>
       <pre class="terminal">$ cf start metrics-ingestor<br>$ cf start mysql-logqueue</pre>
    <li>
      Run the following commands and search the app logs for <code>ERROR</code> messages containing additional information:
    </li>
     <pre class="terminal">$ cf logs metrics-ingestor --recent<br>$ cf logs mysql-logqueue --recent</pre>
     <p class="note"><strong>Note</strong>: In some cases, the apps cannot communicate due to TLS certificate verification failure.
      If your deployment uses self-signed certs, ensure the <b>Disable SSL certificate verification for this environment</b> box is selected
      in the Elastic Runtime <b>Networking</b> pane.</p>
  </ol>
</tr>
</table>

<h4>Failed to connect to mysql</h4>

<table border='1' class='nice'>
<tr>
  <th width="22%">Error</th>
  <td><code>Failed to connect to mysql</code>
  </td>
</tr>
<tr>
  <th>Cause</th>
  <td>MySQL is not running properly.</td>
</tr>
<tr>
  <th>Solution</th>
  <td>
  <ol>
    <li>
    Check the logs of the MySQL Server and MySQL Proxy jobs for errors.  
      <ul><li>You can download the logs from the PCF Metrics tile under the <b>Status</b> tab.</li></ul>
    </li>
    <li>From the cf CLI, target the <code>system</code> org and <code>metrics-v1-3</code> space of your PCF deployment:</li>
    <pre class="terminal">$ cf target -o system -s metrics-v1-3</pre>
    <li>
    Run the following command and ensure the security group can access the MySQL jobs:
    <p class="note"><strong>Note</strong>: PCF Metrics creates a default security group to allow all traffic to its apps.</p>
    </li>
    <pre class="terminal">$ cf security-group metrics-api</pre>
  </ol></td>
</tr>
</table>

<h4>Failed to start elasticsearch client</h4>

<table border='1' class='nice'>
<tr>
  <th width="22%">Error</th>
  <td><code>Failed to start elasticsearch client</code>
  </td>
</tr>
<tr>
  <th>Cause</th>
  <td>Elasticsearch is not running correctly.</td>
</tr>
<tr>
  <th>Solution</th>
  <td>
  <ol>
    <li>
    Check the logs of the Elasticsearch Master, Elasticsearch Coordinator (for 1.3.4 or lower), and Elasticsearch Data jobs for errors.  
      <ul><li>You can download the logs from the PCF Metrics tile under the <b>Status</b> tab.</li></ul>
    </li>
    <li>From the cf CLI, target the <code>system</code> org and <code>metrics-v1-3</code> space of your PCF deployment:</li>
    <pre class="terminal">$ cf target -o system -s metrics-v1-3</pre>
    <li>
    Run the following command and ensure the security group can access the Elasticsearch jobs:
    <p class="note"><strong>Note</strong>: PCF Metrics creates a default security group to allow all traffic to its apps.</p>
    </li>
    <pre class="terminal">$ cf security-group metrics-api</pre>
  </ol></td>
</tr>
</table>

<h4>Never received app logs</h4>

<table border='1' class='nice'>
<tr>
  <th width="22%">Error</th>
  <td><code>Never received app logs - something in the firehose -> elasticsearch flow is broken</code>
  </td>
</tr>
<tr>
  <th>Cause</th>
  <td>Ingestor is not inserting logs correctly.</td>
</tr>
<tr>
  <th>Solution</th>
  <td>
  <ol>
  <li>From the cf CLI, target the <code>system</code> org and <code>metrics-v1-3</code> space of your PCF deployment:</li>
    <pre class="terminal">$ cf target -o system -s metrics-v1-3</pre>
    <li>Run <code>cf apps</code> to see if these apps are running:
      <ul>
        <li><code>metrics-ingestor</code></li>
        <li><code>elasticsearch-logqueue</code></li>
      </ul>
    </li>
    <li>
      If the apps are not running, run the following commands to start them:
    </li>
      <pre class="terminal">$ cf start metrics-ingestor<br>$ cf start elasticsearch-logqueue</pre>
    <li>
      Run the following commands and search the app logs for <code>ERROR</code> messages containing additional information:
    </li>
     <pre class="terminal">$ cf logs metrics-ingestor --recent<br>$ cf logs elasticsearch-logqueue --recent</pre>
     <p class="note"><strong>Note</strong>: In some cases, you might discover a failure to communicate with Loggregator in the form of a bad handshake error.
         <br><br>Ensure the <b>Loggregator Port</b> setting in the Elastic Runtime tile <b>Networking</b> pane is set to the correct value.
         For AWS, it is <code>4443</code>. For all other IaaSes, it is <code>443</code>.
      </p></td>
  </ol>
</tr>
</table>

<h4>Metrics and Events not available</h4>

<table border='1' class='nice'>
<tr>
  <th width="22%">Error</th>
  <td>
      <code>Network metrics are not available.</code><br>
      <code>Container metrics are not available.</code><br>
      <code>App events are not available.</code>
  </td>
</tr>
<tr>
  <th>Cause</th>
  <td>PCF Metrics is misconfigured and the front end API does not receive logs from MySQL.</td>
</tr>
<tr>
  <th>Solution</th>
  <td> 
  <ol>
  <li>From the cf CLI, target the <code>system</code> org and <code>metrics-v1-3</code> space of your PCF deployment:</li>
    <pre class="terminal">$ cf target -o system -s metrics-v1-3</pre>
    <li>
      Run the following command to check the app logs and investigate the error:
    </li>
     <pre class="terminal">$ cf logs metrics --recent</pre>
  </ol>
  </td>
</tr>
</table>

<h4>Logs and Histograms not available</h4>

<table border='1' class='nice'>
<tr>
  <th width="22%">Error</th>
  <td>
    <code>Logs are not available.</code><br>
    <code>Histograms are not available.</code>
  </td>
</tr>
<tr>
  <th>Cause</th>
  <td>PCF Metrics is misconfigured and the front end API does not receive logs from Elasticsearch.</td>
</tr>
<tr>
  <th>Solution</th>
  <td> 
  <ol>
  <li>From the cf CLI, target the <code>system</code> org and <code>metrics-v1-3</code> space of your PCF deployment:</li>
    <pre class="terminal">$ cf target -o system -s metrics-v1-3</pre>
    <li>
      Run the following command to check the app logs and investigate the error:
    </li>
     <pre class="terminal">$ cf logs metrics --recent</pre>
  </ol>
  </td>
</tr>
</table>

<h3><a id="es-no-start"></a>Elasticsearch Instance does not Start</h3>

<table border='1' class='nice'>
<tr>
  <th width="22%">Error</th>
  <td>The Deployment fails because an Elasticsearch instance does not start (for 1.3.4 or lower)</code>
  </td>
</tr>
<tr>
  <th>Cause</th>
  <td>The instance might not start because its configured heap size is greater than that of the VM that hosts it.</td>
</tr>
<tr>
  <th>Solution</th>
  <td>
    <ol>
      <li>From the PCF Metrics tile in Ops Manager, select the <b>Data Store</b> settings pane.</li>
      <li>Record the value in the <b>Elastic Search Heap Size</b> field.</li>
      <li>Select the <b>Resource Config</b> pane and ensure the following jobs have RAM greater than or equal to the <b>Elastic Search Heap Size</b>
        <ul>
          <li><b>Elasticsearch Master</b></li>
          <li><b>Elasticsearch Coordinator</b></li>
          <li><b>Elasticsearch Data</b></li>
        </ul>
      </li>
      <li>If any of the jobs do not have enough memory, do one of the following:
        <ul>
          <li>Give the job more RAM</li>
          <li>Lower the <b>Elastic Search Heap Size</b></li>
        </ul>
      </li>
    </ol>
  </td>
</tr>
</table>

<h2><a id='ui'></a> No Logs or Metrics in the UI</h2>

<p>In some cases, the PCF Metrics UI might not display metrics and logs after successfully deploying.</p>

<p>Follow the steps in this section to help locate the app or component causing the problem. </p>

<h3><a name="check-lb"></a> Step 1: Check your Load Balancer Configuration</h3>

<p>If you use a load balancer, the event-stream mechanism used by the Metrics UI might be blocked. See the table below to resolve this error. </p>

<p>If you do not use a load balancer, or this issue does not apply to your deployment, proceed to <a href="#check-apps">Step 2: Check the PCF Metrics Apps</a>.</p>

<table>
  <tr>
    <th>Error</th>
    <td>In the case of a customer using an F5 load balancer, metrics and logs were not visible in the UI despite successful ingestion and no UI errors reported.</td>
  </tr>
  <tr>
    <th>Cause</th>
    <td>The root of the issue was the traffic of type text/event-stream was blocked by the F5 load balancer.</td>
  </tr>
  <tr>
    <th>Solution</th>
    <td>When F5 was configured to allow event-stream traffic, the issue was resolved.
</td>
  </tr>
</table>
  

<h3><a name="check-apps"></a> Step 2: Check the PCF Metrics Apps</h3>

<ol>
<li><p>From Ops Manager, click the Elastic Runtime Tile. </p>

<ol>
<li>Click the <strong>Credentials</strong> tab.</li>
<li>Under the <strong>UAA</strong> job, next to <strong>Admin Credentials</strong>, click <strong>Link to Credential</strong>. </li>
<li>Record the username and password for use in the next step. </li>
</ol></li>
<li><p>Log in to the Cloud Foundry Command Line Interface (cf CLI) using the credentials from the previous step. 
<pre class="terminal">$ cf login -a http<span>s</span>://api.YOUR-SYSTEM-DOMAIN -u admin -p PASSWORD</pre> </p></li>
<li><p>When prompted, select the <code>system</code> org and the <code>metrics-v1-3</code> space. </p></li>
<li><p>Ensure that the output displays the following apps, each in a <code>started</code> state:</p>

<ul>
<li><code>metrics-ingestor</code></li>
<li><code>mysql-logqueue</code></li>
<li><code>elasticsearch-logqueue</code></li>
<li><code>metrics-aggregator</code></li>
<li><code>metrics</code></li>
<li><code>worker-app-dev</code></li>
<li><code>worker-app-logs</code></li>
<li><code>worker-health-check</code></li>
<li><code>worker-reaper</code></li>
</ul></li>
<li><p>Check the logs of each app for errors using the following command:
<pre class="terminal">$ cf logs APP-NAME --recent</pre>
If you do not see any output, or if you did not find any errors, proceed to <a href="#check-es-cluster">Step 3: Check the Elasticsearch Cluster</a>.</p></li>
</ol>

<h3><a name="check-es-cluster"></a>Step 3: Check the Elasticsearch Cluster</h3>

<ol>
<li><p>From Ops Manager, select the PCF Metrics tile. </p></li>
<li><p>Under the <strong>Status</strong> tab, record the IP of an <strong>Elasticsearch Master</strong> node.  </p></li>
<li><p>Use <code>bosh ssh</code> to access the VM from the previous step.
For instructions, see <a href="http://docs.pivotal.io/pivotalcf/customizing/trouble-advanced.html#prepare">Advanced Troubleshooting with the BOSH CLI</a>.</p></li>
<li><p>Run the following command to list all the Elasticsearch indices:
<pre class="terminal">$ curl localhost:9200/_cat/indices?v | sort
<br> 
green  open   app_logs_1477512000   8   1  125459066            0     59.6gb         29.8gb
green  open   app_logs_1477526400   8   1  129356671            0     59.1gb         29.5gb
green  open   app_logs_1478174400   8   1  129747170            0     61.9gb         30.9gb
. . .
green  open   app_logs_1478707200   8   1  128392686            0     63.2gb         31.6gb
green  open   app_logs_1478721600   8   1  102005754            0     53.5gb         26.5gb
health status index               pri rep docs.count docs.deleted store.size pri.store.size
</pre></p>

<ol>
<li>If the curl does not return a <code>success</code> response, Elasticsearch might not even be running correctly. Inspect the following logs for any failures or errors:

<ul>
<li><code>/var/vcap/sys/log/elasticsearch/elasticsearch.stdout.log</code></li>
<li><code>/var/vcap/sys/log/elasticsearch/elasticsearch.stderr.log</code></li>
</ul></li>
</ol></li>
<li><p>Examine the <code>status</code> column of the output.</p>

<ol>
<li>If the status of any of the indices is not <code>green</code>, restart the Logqueue app:
<pre class="terminal">$ cf restart elasticsearch-logqueue</pre></li>
<li>Run the curl command periodically to see if the indices recover to a <code>green</code> status.</li>
</ol></li>
<li><p>Run the curl command several more times and examine the most recent index to see if the number of stored documents periodically increases.
<p class="note"><strong>Note</strong>: The last row of the output corresponds to the most recent index.
 The sixth column displays the number of documents for the index.</p></p>

<ol>
<li>If all indices show a <code>green</code> status, but the number of documents does not increase,
there is likely a problem further up in ingestion.
Proceed to to <a href="#check-es-logqueue">Step 4: Check the Elasticsearch Logqueue</a>.</li>
</ol></li>
</ol>

<h3><a name="check-es-logqueue"></a>Step 4: Check the Elasticsearch Logqueue</h3>

<ol>
<li><p>Run <code>cf apps</code> to see if the <code>elasticsearch-logqueue</code> app instances are <code>started</code>.</p></li>
<li><p>If any instance of the app is <code>stopped</code>, run the following command to increase logging:
<pre class="terminal">$ cf set-env elasticsearch-logqueue LOG_LEVEL DEBUG</pre></p>

<ol>
<li>Run the following command to stream logs:
<pre class="terminal">$ cf logs elasticsearch-logqueue</pre></li>
<li>In a different terminal window, run the following command:
<pre class="terminal">$ cf restage elasticsearch-logqueue</pre></li>
<li>Watch the logs emitted by the <code>elasticsearch-logqueue</code> app for errors. 

<ul>
<li>A common error is that the app cannot connect to Elasticsearch 
because a user deleted the application security group (ASG) 
that PCF Metrics creates to allow the Logqueue app to connect to the Elasticsearch VMs.
You can run <code>cf security-group metrics-api</code> to see if the ASG exists. 
If not, see <a href="http://docs.pivotal.io/pivotalcf/adminguide/app-sec-groups.html">Creating Application Security Groups</a>.</li>
</ul></li>
</ol></li>
<li><p>If the app is started and you do not find any errors, proceed to <a href="#check-ingestor">Step 5: Check the Metrics Ingestor</a>.</p></li>
</ol>

<h3><a name="check-ingestor"></a>Step 5: Check the Metrics Ingestor</h3>

<ol>
<li>Run <code>cf apps</code> to see if the <code>metrics-ingestor</code> app instances are <code>started</code>. </li>
<li><p>If any of the app instances are <code>stopped</code>, run the following command to increase logging:
<pre class="terminal">$ cf set-env metrics-ingestor LOG_LEVEL DEBUG</pre></p>

<ol>
<li>Run the following command to stream logs:
<pre class="terminal">$ cf logs metrics-ingestor</pre></li>
<li>In a different terminal window, run the following command:
<pre class="terminal">$ cf restage metrics-ingestor</pre></li>
<li>Watch the logs emitted by the <code>metrics-ingestor</code> app for errors. See the list below for common errors:

<ul>
<li><strong>Cannot connect to the firehose</strong>: PCF Metrics creates a UAA user to authenticate the connection to the Firehose.
This user must have the <code>doppler.firehose</code> authority.</li>
<li><strong>Cannot connect to the logqueues</strong>: There might be a problem with the UAA, or it could be throttling traffic.</li>
<li><strong>WebSocket Disconnects</strong>: If you see Websocket disconnects logs in the Ingestor app, consider adding additional Ingestor instances.
The Firehose might be dropping the Ingestor connection to avoid back pressure.</li>
</ul></li>
</ol></li>
<li><p>If the app is started and you do not find any errors, proceed to <a href="#check-mysql">Step 6: Check MySQL</a>.</p></li>
</ol>

<h3><a name="check-mysql"></a>Step 6: Check MySQL</h3>

<ol>
<li><p>From Ops Manager, select the PCF Metrics tile. </p></li>
<li><p>Under the <strong>Status</strong> tab, record the IP of a <strong>MySQL Server</strong> node.  </p></li>
<li><p>Use <code>bosh ssh</code> to access the VM from the previous step.
For instructions, see <a href="http://docs.pivotal.io/pivotalcf/customizing/trouble-advanced.html#prepare">Advanced Troubleshooting with the BOSH CLI</a>.</p></li>
<li><p>Log in to mysql by running <code>mysql -u USERNAME -p PASSWORD</code> 
<p class="note"><strong>Note</strong>: If you do not know the username and password,
you can run <code>cf env mysql-logqueue</code> with the <code>system</code> org and the <code>metrics-v1-3</code> space targeted.</p></p></li>
<li><p>Verify that the database was bootstrapped correctly:</p>

<ol>
<li>Run <code>show databases</code> and check for a <code>metrics</code> database.

<ol>
<li>If there is no <code>metrics</code> database, the <code>migrate_db</code> errand of the BOSH release might not have run or succeeded.
Ensure the errand is selected in the tile configuration and update the tile.</li>
</ol></li>
</ol></li>
<li><p>Run <code>use metrics</code> to select the <code>metrics</code> database:
<pre class="terminal">mysql&gt; use metrics;</pre></p></li>
<li><p>Run <code>show tables</code> and ensure you see the following tables:</p>

<p><img alt="Tables in Metrics" src="images/metrics-tables.png" /></p></li>
<li><p>Enter the following query several times to verify that the value returned does not decrease over time:
<pre class="terminal">mysql&gt; select count(*) from metrics.app_metric_rollup where timestamp &gt; ((UNIX_TIMESTAMP() - 60) * POW(10, 3));</pre>
This command displays the rate at which metrics flow in over the last minute.</p>

<ol>
<li>If the command returns <code>0</code> or a consistently decreasing value, the problem is likely further up in ingestion.
 Proceed to <a href="#check-mysql-logqueue">Step 7: Check the MySQL Logqueue</a>. </li>
</ol></li>
</ol>

<h3><a name="check-mysql-logqueue"></a> Step 7: Check the MySQL Logqueue</h3>

<ol>
<li><p>Run <code>cf apps</code> to see if the <code>mysql-logqueue</code> app instances are <code>started</code>.</p></li>
<li><p>If any instance of the app is <code>stopped</code>, run the following command to increase logging:
<pre class="terminal">$ cf set-env mysql-logqueue LOG_LEVEL DEBUG</pre></p>

<ol>
<li>Run the following command to stream logs:
<pre class="terminal">$ cf logs mysql-logqueue</pre></li>
<li>In a different terminal window, run the following command:
<pre class="terminal">$ cf restage mysql-logqueue</pre></li>
<li>Watch the logs emitted by the <code>mysql-logqueue</code> app for errors. 

<ul>
<li>A common error is that the app cannot connect to MySQL
because a user deleted the application security group (ASG)
that PCF Metrics creates to allow the Logqueue app to connect to the MySQL VMs.
You can run <code>cf security-group metrics-api</code> to see if the ASG exists.
If not, see <a href="http://docs.pivotal.io/pivotalcf/adminguide/app-sec-groups.html">Creating Application Security Groups</a>.</li>
</ul></li>
</ol></li>
<li><p>If the app is started and you do not find any errors, proceed to <a href="#check-aggregator">Step 8: Check the Metrics Aggregator</a>.</p></li>
</ol>

<h3><a name="check-aggregator"></a>Step 8: Check the Metrics Aggregator</h3>

<ol>
<li><p>Run <code>cf apps</code> to see if the <code>metrics-aggregator</code> app instances are <code>started</code>.</p></li>
<li><p>If any instance of the app is <code>stopped</code>, run the following command to increase logging:
<pre class="terminal">$ cf set-env metrics-aggregator LOG_LEVEL DEBUG</pre></p>

<ol>
<li>Run the following command to stream logs:
<pre class="terminal">$ cf logs metrics-aggregator</pre></li>
<li>In a different terminal window, run the following command:
<pre class="terminal">$ cf restage metrics-aggregator</pre></li>
<li>Watch the logs emitted by the <code>metrics-aggregator</code> app for errors. 

<ul>
<li>A common error is that the app cannot connect to MySQL
because a user deleted the application security group (ASG)
that PCF Metrics creates to allow the aggregator app to connect to the MySQL VMs.
You can run <code>cf security-group metrics-api</code> to see if the ASG exists.
If not, see <a href="http://docs.pivotal.io/pivotalcf/adminguide/app-sec-groups.html">Creating Application Security Groups</a>.</li>
</ul></li>
</ol></li>
</ol>

<h2><a id='mysql'></a> MySQL Node Failure</h2>

<p>In some cases, a MySQL server node might fail to restart.
The following two sections describe the known conditions that cause this failure as well as steps for diagnosing and resolving them.
If neither of the causes listed apply, the final section provides instructions for re-deploying BOSH as a last resort to resolve the issue. </p>

<h3>Cause 1: monit Timed Out</h3>

<h4>Diagnose</h4>

<p>Follow these steps to see if a <code>monit</code> time-out caused the MySQL node restart to fail:</p>

<ol>
<li>Use <code>bosh ssh</code> to access the failing node, using the IP address in the Ops Manager Director tile <strong>Status</strong> tab. 
For instructions, see <a href="http://docs.pivotal.io/pivotalcf/customizing/trouble-advanced.html#prepare">Advanced Troubleshooting with the BOSH CLI</a>.</li>
<li>Run <code>monit summary</code> and check the status of the <code>mariadb_ctrl</code> job. </li>
<li>If the status of the <code>mariadb_ctrl</code> job is <code>Execution Failed</code>, open the following file: <code>/var/vcap/sys/log/mysql/mariadb_ctrl.combined.log</code>. 

<ol>
<li>If the last line of the log indicates that MySQL started without issue, such as in the example below,
<code>monit</code> likely timed out while waiting for the job to report healthy. Follow the steps below to resolve the issue.
<pre class="terminal">
{&quot;timestamp&quot;:&quot;1481149250.288255692&quot;,&quot;source&quot;:&quot;/var/vcap/packages/<br>mariadb_ctrl/bin/mariadb_ctrl&quot;,&quot;message&quot;:&quot;/var/vcap/packages/<br>mariadb_ctrl/bin/mariadb_ctrl.mariadb_ctrl<br> started&quot;,&quot;log_level&quot;:1,&quot;data&quot;:{}}
</pre></li>
</ol></li>
</ol>

<h4>Resolve</h4>

<p>Run the following commands to return the <code>mariadb_ctrl</code> job to a healthy state:</p>

<ol>
<li>Run <code>monit unmonitor mariadb</code>.</li>
<li>Run <code>monit monitor mariadb</code>.</li>
<li>Run <code>monit summary</code> and confirm that the output lists <code>mariadb_ctrl</code> as <code>running</code>. </li>
</ol>

<h3>Cause 2: Bin Logs Filled up the Disk</h3>

<h4>Diagnose</h4>

<ol>
<li>Use <code>bosh ssh</code> to access the failing node.
For instructions, see <a href="http://docs.pivotal.io/pivotalcf/customizing/trouble-advanced.html#prepare">Advanced Troubleshooting with the BOSH CLI</a>. </li>
<li>Open the following log file: <code>/var/vcap/sys/log/mysql/mysql.err.log</code>.</li>
<li>If you see log messages that indicate insufficient disk space, the <a href="https://bosh.io/docs/persistent-disks.html">persistent disk</a> is likely storing too many bin logs.
Confirm insufficient disk space by doing the following:

<ol>
<li>Run <code>df -h</code>. 

<ol>
<li>Ensure that you see the <code>/var/vcap/store</code> folder is at or over <code>90%</code> usage.</li>
</ol></li>
<li>Navigate to <code>/var/vcap/store/mysql</code> and run <code>ls -al</code>. 

<ol>
<li>Ensure that you see many files named with the format <code>mysql-bin.########</code>.</li>
</ol></li>
</ol></li>
</ol>

<p>In MySQL for PCF, the server node does not make use of these logs and you can remove all except the most recent bin log.
Follow the steps below to resolve the issue. </p>

<h4>Resolve</h4>

<ol>
<li>Log in to mysql by running <code>mysql -u USERNAME -p PASSWORD</code> 
<p class="note"><strong>Note</strong>: If you do not know the username and password, you can run <code>cf env mysql-logqueue</code> with the <code>system</code> org and the <code>metrics-v1-3</code> space targeted.</p></li>
<li>Run <code>use metrics;</code>.</li>
<li>Run the following command:
<pre class="terminal">mysql&gt; PURGE BINARY LOGS BEFORE &#39;YYYY-MM-DD HH:MM:SS&#39;; </pre></li>
</ol>

<h3>Re-deploy BOSH to Restart the Node</h3>

<p>If troubleshooting based on the causes mentioned above did not resolve the issue with your failing MySQL node,
you can follow the steps below to recover it.
Pivotal recommends only using this procedure as a if there are no other potential solutions available. </p>

<p class="note warning">
<strong>WARNING: </strong>
This procedure is extremely costly in terms of time and network resources.
The cluster takes a significant amount of time to put the data replicated to the rest of the cluster back into the rebuilt node.
This procedure consumes considerable network bandwidth as potentially hundreds of gigabytes of data needs to transfer.
</p>

<h4>Stop the Ingestor App</h4>

<ol>
<li>From Ops Manager, click the Elastic Runtime Tile. 

<ol>
<li>Click the <strong>Credentials</strong> tab.</li>
<li>Under the <strong>UAA</strong> job, next to <strong>Admin Credentials</strong>, click <strong>Link to Credential</strong>. </li>
<li>Record the username and password for use in the next step. </li>
</ol></li>
<li>Log in to the cf CLI using the credentials from the previous step. 
<pre class="terminal">$ cf login -a http<span>s</span>://api.YOUR-SYSTEM-DOMAIN -u admin -p PASSWORD</pre> </li>
<li>Target the <code>system</code> org and <code>metrics-v1-3</code> space of your PCF deployment:
<pre class="terminal">$ cf target -o system -s metrics-v1-3</pre></li>
<li>Stop data flow into the Galera cluster:
<pre class="terminal">$ cf stop metrics-ingestor</pre></li>
</ol>

<h4>Edit Your Deployment Manifest</h4>

<ol>
<li>Follow the steps in the <a href="https://docs.pivotal.io/pivotalcf/customizing/trouble-advanced.html#log-in">Log in to BOSH</a> section
of the Advanced Troubleshooting with the BOSH CLI topic to target and log in to your BOSH Director.
The steps vary slightly depending on whether your PCF deployment uses internal authentication or an external user store.</li>
<li>Download the manifest of your PCF deployment: 
<pre class="terminal">
$ bosh download manifest YOUR-PCF-DEPLOYMENT YOUR-PCF-MANIFEST.yml
</pre>
<p class="note"><strong>Note</strong>: You must know the name of your PCF deployment to download the manifest. To retrieve it, run <code>bosh deployments</code> 
to list your deployments and locate the name of your PCF deployment.</p></li>
<li>Open the manifest and set the number of instances of the failed server node to <code>0</code>.</li>
<li>Run <code>bosh deployment YOUR-PCF-MANIFEST.yml</code> to specify your edited manifest.</li>
<li>Run <code>bosh deploy</code> to deploy with your manifest. </li>
<li>Run <code>bosh disks --orphaned</code> to see the <a href="https://bosh.io/docs/persistent-disks.html">persistent disk</a> or disks associated with the failed node.

<ol>
<li>Record the <code>CID</code> of each persistent disk.</li>
<li>Contact <a href="http://support.pivotal.io/">Pivotal Support</a> to walk through re-attaching the orphaned disks to new VMs to preserve their data.</li>
</ol></li>
<li>Open the manifest and set the number of instances of the failed server node to <code>1</code>.</li>
<li>Run <code>bosh deploy</code> to deploy with your edited manifest. </li>
<li>Wait for BOSH to rebuild the node.</li>
</ol>

<h2><a id='mysql-sst'></a> MySQL SST Disabled Error</h2>

<p>If you see the message below on a failing node in <code>/var/vcap/sys/log/mysql/mysql.err.log</code>,
you can resolve the error by following the instructions in the <a href="http://docs.pivotal.io/p-mysql/monitoring-mysql.html#logs">Interruptor Logs</a> section
of the MySQL for PCF documentation. </p>

<pre class="terminal">
WSREP_SST: [ERROR] ############################################################################## (20160610 04:33:21.338)
WSREP_SST: [ERROR] SST disabled due to danger of data loss. Verify data and bootstrap the cluster (20160610 04:33:21.340)
WSREP_SST: [ERROR] ############################################################################## (20160610 04:33:21.341)
</pre>

<h2><a id='log'></a> Log Errors</h2>

<table border='1' class='nice'>
<tr>
  <th width="22%">Error</th>
  <td>
    The PCF Metrics UI does not show any new logs from Elasticsearch. 
  </td>
</tr>
<tr>
  <th>Cause</th>
  <td>The tile deployed with the <code>Push PCF Metrics Data Components</code> errand deselected</td>
</tr>
<tr>
  <th>Solution</th>
  <td>
  Restart the Elasticsearch Logqueue using the <a href="http://docs.pivotal.io/pivotalcf/cf-cli/index.html">cf CLI</a> as follows:
  <ol>
    <li>Target the <code>system</code> org and <code>metrics-v1-3</code> space of your PCF deployment:</li>
    <pre class="terminal">$ cf target -o system -s metrics-v1-3</pre>
    <li>Run the following command to restart the Logqueue application:</li>
    <pre class="terminal">$ cf restart elasticsearch-logqueue</pre>
  </ol>
    <p class="note"><strong>Note</strong>: To avoid having to apply this fix in the future,
    select the checkbox to enable the <code>Push PCF Metrics Data Components</code> <a href="./installing.html#errands">errand</a> before your next tile update. </p>
  </td>
</tr>
</table>

<h2><a id="503"></a>503 Errors</h2>

<table>
  <tr>
      <th>Error</th>
      <td>You encounter <code>503</code> errors when accessing the PCF Metrics UI in your browser.</td>
  </tr>
  <tr>
      <th>Cause</th>
      <td>Your Elasticsearch nodes might have become unresponsive.</td>
  </tr>
  <tr>
      <th>Solution</th>
      <td>Check the Elasticsearch index health by following the procedure below, and consider adding additional Elasticsearch nodes.
      <br><br>
      <ol>
        <li>Retrieve the IP address of your Elasticsearch master node by navigating to the <b>Metrics</b> tile in the Ops Manager Installation Dashboard,
            clicking the <b>Status</b> tab, and recording the IP address next to <b>ElasticSearchMaster</b>.</li>
        <img src="images/elasticsearch-ip.png" />
        <li>SSH into the Ops Manager VM by following the instructions in <a href="http://docs.pivotal.io/pivotalcf/customizing/trouble-advanced.html#ssh">SSH into Ops Manager</a>.</li>
        <li>From the Ops Manager VM, use <code>curl</code> to target the IP address of your Elasticsearch master node.
            Follow the instructions in the <a href="https://www.elastic.co/guide/en/elasticsearch/reference/2.2/_cluster_health.html">Cluster Health</a> topic of the Elasticsearch documentation.</li>
      </ol>

      </td>
  </tr>
</table>

<h2><a id="fetch-apps"></a>Failed to Fetch Apps</h2>

<table>
  <tr>
      <th>Error</th>
      <td>Even though you entered the correct UAA credentials, the metrics app fails to fetch the list of apps.</td>
  </tr>
  <tr>
      <th>Cause</th>
      <td>The browser plugins or cookies inject extraneous content in requests to Cloud Controller API, causing it to reject the request.</td>
  </tr>
  <tr>
      <th>Solution</th>
      <td>Confirm the problem and clear the browser, as follows:
      <ol>
        <li>Try the browser&rsquo;s incognito mode to see if the metrics app is able to fetch the list of apps.
             If this works, the problem is likely cookies or plugins.</li>
        <li>Clear your browser cookies and plugins.</li>
       </ol>
       </td>
  </tr>
</table>

        <div><a id='repo-link' href='http://github.com/pivotal-cf/docs-metrics/tree/1.3/troubleshooting.html.md.erb'>View the source for this page in GitHub</a></div>

      </main>
    </div>
  </div>
</div>

<div id="scrim"></div>

<div class="container">
  <footer class="site-footer-links">
    <div class="copyright">
  <a href='https://pivotal.io/privacy-policy'>Privacy Policy</a> | 
  <a href='https://pivotal.io/terms-of-use'>Terms of Use</a><br/>
  <a href='/'>Pivotal Documentation</a>
  &copy; 2017 <a href='https://pivotal.io'>Pivotal Software</a>, Inc. All Rights Reserved.
</div>
<div class="support">
  Need help? <a href="http://support.pivotal.io" target="_blank">Visit Support</a>
</div>

  </footer>
</div><!--end of container-->

</body>
</html>
