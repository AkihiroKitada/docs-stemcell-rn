<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <!-- Always force latest IE rendering engine or request Chrome Frame -->
  <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">

  <link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,300italic,400italic,400,600' rel='stylesheet' type='text/css'>
  <!-- Use title if it's in the page YAML frontmatter -->
  <title>
      PCF Metrics Product Architecture |
    Pivotal Docs
  </title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="/stylesheets/all.css" rel="stylesheet" media="screen, print" />
  <link href="/stylesheets/print.css" rel="stylesheet" media="print" />
  <link href='/images/favicon.ico' rel='shortcut icon'>

  <script src="/javascripts/all.js"></script>
  
<script type="text/javascript">
  if (window.location.host === 'docs.pivotal.io') {
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-39702075-1']);
    _gaq.push(['_setDomainName', 'pivotal.io']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script');
      ga.type = 'text/javascript';
      ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0];
      s.parentNode.insertBefore(ga, s);
    })();
  }
</script>

<script type="text/javascript">
  var blackList = ['acceptance'];

  blackList.forEach(function(blackListedEnv) {
    if (document.URL.indexOf(blackListedEnv) > -1 && blackListedEnv != "") {
      $('head').append('<meta name="hashtag" content="PivotalMoment">');
    }
  });
</script>

<!-- CrazyEgg Tracking Script -->
  <script type="text/javascript">
  setTimeout(function(){var a=document.createElement("script");
  var b=document.getElementsByTagName("script")[0];
  a.src=document.location.protocol+"//script.crazyegg.com/pages/scripts/0055/2990.js?"+Math.floor(new Date().getTime()/3600000);
  a.async=true;a.type="text/javascript";b.parentNode.insertBefore(a,b)}, 1);
  </script>

<!-- Munchkin Marketo Script -->
<script type="text/javascript">
  (function() {
    var didInit = false;

    function initMunchkin() {
      if (didInit === false) {
        didInit = true;
        Munchkin.init('625-IUJ-009');
      }
    }

    var s = document.createElement('script');
    s.type = 'text/javascript';
    s.async = true;
    s.src = document.location.protocol + '//munchkin.marketo.net/munchkin.js';
    s.onreadystatechange = function() {
      if (this.readyState == 'complete' || this.readyState == 'loaded') {
        initMunchkin();
      }
    };
    s.onload = initMunchkin;
    document.getElementsByTagName('head')[0].appendChild(s);
  })();
</script>

</head>

<body class="pcf-metrics pcf-metrics_1-4 pcf-metrics_1-4_architecture has-subnav">

<div class="viewport">
  <div class='wrap'>
    <script type="text/javascript">
      document.domain = "pivotal.io";
    </script>

      <header class="global-header header header-layout js-bar-links">
    <a class="pivotal-logo" href="/">
    </a>
    <a href="/" class="global-header-title">
      <span class="title-deemph">Pivotal</span> Documentation
    </a>
    <div class="btn-menu" data-behavior="MenuMobile"></div>
    <div class="header-links">
      <div class="header-item">
        <a href="https://network.pivotal.io/">Downloads</a>
      </div>
      <div class="header-item">
        <a href="http://support.pivotal.io" target="_blank">Support</a>
      </div>

      <div class="header-item embedded-searchbar">
          <form method="get" action="/search">
            <input name="q" placeholder="Search PCF Metrics 1.4" class="search-box" />
              <input type="hidden" name="product_name" value="PCF Metrics" />
              <input type="hidden" name="product_version" value="1.4"/>
          </form>
      </div>
      
    </div>
  </header>



    <div class="container">

      <!--googleoff: index-->
      <div id="sub-nav" class="js-sidenav nav-container" role="navigation">
  <a class="sidenav-title" data-behavior="SubMenuMobile">
    Doc Index
  </a>
  <div class="nav-content">
    <ul>
      <li>
        <a id='home-nav-link' href="/pcf-metrics/1-4/index.html">Pivotal Cloud Foundry Metrics</a>
      </li>

      <li>
        <a href="/pcf-metrics/1-4/installing.html">Installing PCF Metrics</a>
      </li>

      <li>
        <a href="/pcf-metrics/1-4/sizing.html">Sizing PCF Metrics for Your System</a>
      </li>

      <li>
        <a href="/pcf-metrics/1-4/using.html">Monitoring and Troubleshooting Apps with PCF Metrics</a>
      </li>

      <li>
        <a href="/pcf-metrics/1-4/monitoringpcfmetrics.html">Monitoring PCF Metrics</a>
      </li>

      <li>
        <a href="/pcf-metrics/1-4/troubleshooting.html">Troubleshooting PCF Metrics</a>
      </li>

      <li>
        <a href="/pcf-metrics/1-4/architecture.html">PCF Metrics Product Architecture</a>
      </li>

      <li>
        <a href="/pcf-metrics/1-4/rn-ki.html">Release Notes and Known Issues</a>
      </li>

    </ul>
  </div>
</div><!--end of sub-nav-->
      <!--googleon: index-->

      <main class="content content-layout" id="js-content" role="main">
        <a id="top"></a>
          <div class="local-header title-container">
    <div class="local-header version-info">
      LATEST VERSION: 1.4 - <a href="">CHANGELOG</a>
    </div>
    <div class="local-header local-title clearfix">
      <img src="/images/cloud_rings.png">
      <span class="local-header-title">PCF Metrics
      </span>
      <span class="local-header local-version header-dropdown">
        <a class="local-header header-dropdown-link">v1.4</a>
        <span class="local-header header-dropdown-content">
          <ul>
                <li>
                    <a href="http://docs.pivotal.io/pcf-metrics/1-3/architecture.html">v1.3</a>
                </li>
                <li>
                    <a href="http://docs.pivotal.io/pcf-metrics/1-2/architecture.html">v1.2</a>
                </li>
                <li>
                    <a href="http://docs.pivotal.io/pcf-metrics/1-1/architecture.html">v1.1</a>
                </li>
                <li>
                    <a href="http://docs.pivotal.io/pcf-metrics/1-0/architecture.html">v1.0</a>
                </li>
          </ul>
        </span>
      </span>

      <!-- search was here -->
    </div>
    <div class="local-header local-header-links">
    </div>
  </div>

          <h1 class="title-container" >
    PCF Metrics Product Architecture
  </h1>

          <div id="js-quick-links" class="list-style-none">
            <div class="quick-links"><ul>
<li><a href="#overview">Overview</a></li>
<li><a href="#data-flow">How Data Flows from the Firehose to the Datastores</a></li>
<li><a href="#user-flow">How the PCF Metrics UI Retrieves Data from the Datastores</a></li>
</ul></div>
          </div>
        <div class="to-top" id="js-to-top">
          <a href="#top" title="back to top"></a>
        </div>
        <p>This topic describes the product architecture of Pivotal Cloud Foundry (PCF) Metrics.</p>

<h2><a id="overview"></a>Overview</h2>

<p>The diagram below displays the components of PCF Metrics, as well as the Cloud Foundry components that the PCF Metrics system interacts with.</p>

<p>PCF Metrics deploys several Cloud Foundry apps as part of the install process. These components are the bold rectangles in the diagram. The cylinders represent the data storage components of PCF Metrics. </p>

<p><img src="images/architecture.png" /></p>

<p>See the following sections to understand the processes that happen within the PCF Metrics system.</p>

<h2><a id="data-flow"></a> How Data Flows from the Firehose to the Datastores</h2>

<p>This section describes how PCF Metrics fills its datastores. PCF Metrics uses three datastores:</p>

<ul>
<li>The MySQL component stores metric and event data from the apps running on your PCF deployment. 

<ul>
<li>Examples of events are <code>start</code> and <code>stop</code>. </li>
<li>Examples of metrics are <em>container metrics</em> such as CPU and <em>network metrics</em> such as Requests. </li>
</ul></li>
<li>The Elasticsearch component stores logs from the apps running on your PCF deployment.</li>
<li>The Redis component is used to cache data ingested from the Firehose and data queried by the Metrics API.</li>
</ul>

<h3>Components</h3>

<p>The diagram below highlights the components involved in the process of getting metric and log data into the Elasticsearch and MySQL datastore.</p>

<p><img alt="process one" src="images/process1.png" /></p>

<h3>Process</h3>

<p>The following table describes how the components act during each stage.</p>

<table>
    <tr>
        <th>Stage</th>
        <th>Description</th>
    </tr>
    <tr>
        <td valign="top">1</td>
        <td>
        The <code>metrics-ingestor</code> app receives app logs, container metrics, and network metrics from the Firehose and forwards them to Redis.
        <br><br>
        Redis does the following:
            <ul>
                <li>Acts as a buffer for events and metrics data</li>
                <li>Acts as a cache</li>
            </ul>
        </td>
    </tr>
    <tr>
        <td valign="top">2</td>
        <td>
        Each of the logqueues acts independently, writing information to the datastores:
        <br><br>
        
        <b>Elasticsearch logqueue</b>
        <br><br>
        The <code>elasticsearch-logqueue</code> app reads data from Redis and checks whether the Elasticsearch datastore is available. If available, the app writes logs to the Elasticsearch datastore.
        <br><br>
        
        <b>MySQL logqueue</b>
        <br><br>
        The <code>mysql-logqueue</code> app reads data from Redis and checks whether the MySQL datastore is available. If the datastore is available, the app does the following:<br><br>
        <ul>
            <li>Inserts container and network metrics into MySQL with 1-minute granularity</li>
            <li>Parses app log messages for an app event name and inserts the event into MySQL</li>
        </ul>
    </tr>
</table>

<h2><a id="user-flow"></a> How the PCF Metrics UI Retrieves Data from the Datastores</h2>

<p>This section describes the flow of data through the system when you interact with the PCF Metrics UI. </p>

<h3>Components</h3>

<p>The diagram below highlights the components involved in this process.</p>

<p><img alt="Process 2" src="images/process2.png" /></p>

<h3>Process</h3>

<p>The following table describes how the components act during each stage.</p>

<table>
    <tr><th>Stage</th><th>Description</th></tr>
    <tr><td valign="top">1</td>
        <td>
            A user launches <code>metrics.SYSTEM-DOMAIN</code> in a browser and enters their UAA credentials. 
        </td>
    </tr>
    <tr><td valign="top">2</td>
        <td>        
            After the UAA authorizes the user, the browser does the following:
            <br><br>
            <ol>
                <li>Retrieves through the Cloud Controller API a list of apps that the user can access</li>
                <li>Displays a page in which the user can select any app returned by the Cloud Controller API</li>
            </ol>
        </td>
    </tr>
    <tr><td valign="top">3</td>
        <td>
            A user selects an app from the dropdown menu, which does the following:<br></br>
            <ol>
                <li>Opens an AJAX connection to the metrics API to retrieve metrics and logs for the specified time frame</li>
            </ol>
        </td>
    </tr>
    <tr>
        <td valign="top">4</td>
        <td>
            The metrics API receives the requests from the browser and does the following:
            <br><br>
            <ol>
                <li>Communicates with the UAA and Cloud Controller to confirm that the user can access data for the requested app</li>
                <li>Fetches the data from MySQL and Elasticsearch and then streams it to the browser</li>
            </ol>
        </td>
    </tr>
</table>

        <div><a id='repo-link' href='http://github.com/pivotal-cf/docs-metrics/tree/1.4/architecture.html.md.erb'>View the source for this page in GitHub</a></div>

      </main>
    </div>
  </div>
</div>

<div id="scrim"></div>

<div class="container">
  <footer class="site-footer-links">
    <div class="copyright">
  <a href='https://pivotal.io/privacy-policy'>Privacy Policy</a> | 
  <a href='https://pivotal.io/terms-of-use'>Terms of Use</a><br/>
  <a href='/'>Pivotal Documentation</a>
  &copy; 2017 <a href='https://pivotal.io'>Pivotal Software</a>, Inc. All Rights Reserved.
</div>
<div class="support">
  Need help? <a href="http://support.pivotal.io" target="_blank">Visit Support</a>
</div>

  </footer>
</div><!--end of container-->

</body>
</html>
