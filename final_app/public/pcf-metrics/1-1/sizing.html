<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <!-- Always force latest IE rendering engine or request Chrome Frame -->
  <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">

  <link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,300italic,400italic,400,600' rel='stylesheet' type='text/css'>
  <!-- Use title if it's in the page YAML frontmatter -->
  <title>
      Sizing PCF Metrics For Your System |
    Pivotal Docs
  </title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="/stylesheets/all.css" rel="stylesheet" media="screen, print" />
  <link href="/stylesheets/print.css" rel="stylesheet" media="print" />
  <link href='/images/favicon.ico' rel='shortcut icon'>

  <script src="/javascripts/all.js"></script>
  
<script type="text/javascript">
  if (window.location.host === 'docs.pivotal.io') {
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-39702075-1']);
    _gaq.push(['_setDomainName', 'pivotal.io']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script');
      ga.type = 'text/javascript';
      ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0];
      s.parentNode.insertBefore(ga, s);
    })();
  }
</script>

<script type="text/javascript">
  var blackList = ['acceptance'];

  blackList.forEach(function(blackListedEnv) {
    if (document.URL.indexOf(blackListedEnv) > -1 && blackListedEnv != "") {
      $('head').append('<meta name="hashtag" content="PivotalMoment">');
    }
  });
</script>

<!-- CrazyEgg Tracking Script -->
  <script type="text/javascript">
  setTimeout(function(){var a=document.createElement("script");
  var b=document.getElementsByTagName("script")[0];
  a.src=document.location.protocol+"//script.crazyegg.com/pages/scripts/0055/2990.js?"+Math.floor(new Date().getTime()/3600000);
  a.async=true;a.type="text/javascript";b.parentNode.insertBefore(a,b)}, 1);
  </script>

<!-- Munchkin Marketo Script -->
<script type="text/javascript">
  (function() {
    var didInit = false;

    function initMunchkin() {
      if (didInit === false) {
        didInit = true;
        Munchkin.init('625-IUJ-009');
      }
    }

    var s = document.createElement('script');
    s.type = 'text/javascript';
    s.async = true;
    s.src = document.location.protocol + '//munchkin.marketo.net/munchkin.js';
    s.onreadystatechange = function() {
      if (this.readyState == 'complete' || this.readyState == 'loaded') {
        initMunchkin();
      }
    };
    s.onload = initMunchkin;
    document.getElementsByTagName('head')[0].appendChild(s);
  })();
</script>

</head>

<body class="pcf-metrics pcf-metrics_1-1 pcf-metrics_1-1_sizing has-subnav">

<div class="viewport">
  <div class='wrap'>
    <script type="text/javascript">
      document.domain = "pivotal.io";
    </script>

      <header class="global-header header header-layout js-bar-links">
    <a class="pivotal-logo" href="/">
    </a>
    <a href="/" class="global-header-title">
      <span class="title-deemph">Pivotal</span> Documentation
    </a>
    <div class="btn-menu" data-behavior="MenuMobile"></div>
    <div class="header-links">
      <div class="header-item">
        <a href="https://network.pivotal.io/">Downloads</a>
      </div>
      <div class="header-item">
        <a href="http://support.pivotal.io" target="_blank">Support</a>
      </div>

      <div class="header-item embedded-searchbar">
          <form method="get" action="/search">
            <input name="q" placeholder="Search PCF Metrics 1.1" class="search-box" />
              <input type="hidden" name="product_name" value="PCF Metrics" />
              <input type="hidden" name="product_version" value="1.1"/>
          </form>
      </div>
      
    </div>
  </header>



    <div class="container">

      <!--googleoff: index-->
      <div id="sub-nav" class="js-sidenav nav-container" role="navigation">
  <a class="sidenav-title" data-behavior="SubMenuMobile">
    Doc Index
  </a>
  <div class="nav-content">
    <ul>
      <li>
        <a id='home-nav-link' href="/pcf-metrics/1-1/index.html">Pivotal Cloud Foundry Metrics</a>
      </li>

      <li>
        <a href="/pcf-metrics/1-1/installing.html">Installing PCF Metrics</a>
      </li>

      <li>
        <a href="/pcf-metrics/1-1/sizing.html">Sizing PCF Metrics for Your System</a>
      </li>

      <li>
        <a href="/pcf-metrics/1-1/using.html">Using PCF Metrics</a>
      </li>

      <li>
        <a href="/pcf-metrics/1-1/architecture.html">PCF Metrics Product Architecture</a>
      </li>

      <li>
        <a href="/pcf-metrics/1-1/rn-ki.html">Release Notes and Known Issues</a>
      </li>

    </ul>
  </div>
</div><!--end of sub-nav-->

      <!--googleon: index-->

      <main class="content content-layout" id="js-content" role="main">
        <a id="top"></a>
          <div class="local-header title-container">
    <div class="local-header version-info">
      LATEST VERSION: 1.4 - <a href="">CHANGELOG</a>
    </div>
    <div class="local-header local-title clearfix">
      <img src="/images/cloud_rings.png">
      <span class="local-header-title">PCF Metrics
      </span>
      <span class="local-header local-version header-dropdown">
        <a class="local-header header-dropdown-link">v1.1</a>
        <span class="local-header header-dropdown-content">
          <ul>
                <li>
                    <a href="http://docs.pivotal.io/pcf-metrics/1-4/sizing.html">v1.4</a>
                </li>
                <li>
                    <a href="http://docs.pivotal.io/pcf-metrics/1-3/sizing.html">v1.3</a>
                </li>
                <li>
                    <a href="http://docs.pivotal.io/pcf-metrics/1-2/sizing.html">v1.2</a>
                </li>
                <li>
                    <a href="http://docs.pivotal.io/pcf-metrics/1-0/sizing.html">v1.0</a>
                </li>
          </ul>
        </span>
      </span>

      <!-- search was here -->
    </div>
    <div class="local-header local-header-links">
    </div>
  </div>

          <h1 class="title-container" >
    Sizing PCF Metrics For Your System
  </h1>

          <div id="js-quick-links" >
            <div class="quick-links"><ul>
<li>
<a href="#metrics-datastore">Configuring the Metrics Datastore</a><ul>
<li><a href="#metrics-considerations">Considerations for Scaling</a></li>
<li><a href="#metrics-procedures">Procedures for Scaling</a></li>
</ul>
</li>
<li>
<a href="#log-datastore">Configuring the Log Datastore</a><ul>
<li><a href="#log-considerations">Considerations for Scaling</a></li>
<li><a href="#log-procedures">Procedures for Scaling</a></li>
</ul>
</li>
<li>
<a href="#ingestor">Configuring the Ingestor</a><ul>
<li><a href="#ingestor-considerations">Considerations for Scaling</a></li>
<li><a href="#ingestor-procedures">Procedures for Scaling</a></li>
</ul>
</li>
<li>
<a href="#logqueue">Configuring the Logqueue</a><ul>
<li><a href="#logqueue-considerations">Considerations for Scaling</a></li>
<li><a href="#logqueue-procedures">Procedures for Scaling</a></li>
</ul>
</li>
<li>
<a href="#troubleshooting">Troubleshooting</a><ul>
<li><a href="#common-issues">Common Issues</a></li>
<li><a href="#check-cluster-health">Check Elasticsearch Cluster Health</a></li>
</ul>
</li>
</ul></div>
          </div>
        <div class="to-top" id="js-to-top">
          <a href="#top" title="back to top"></a>
        </div>
        <style>
    .note.warning {
        background-color: #fdd;
        border-color: #fbb
    }

    .note.warning:before {
        color: #f99;
     }
</style>

<p>This topic describes how to configure Pivotal Cloud Foundry (PCF) Metrics for high availability. Operators can use these procedures to optimize PCF Metrics for high capacity.</p>

<p>For more information about PCF Metrics components, see the <a href="/pcf-metrics/1-1/architecture.html">PCF Metrics Product Architecture</a> topic.</p>

<h2><a id='metrics-datastore'></a> Configuring the Metrics Datastore</h2>

<p>PCF Metrics uses three In-memory Database System (IMDS) components: </p>

<ul>
<li>The Container Metrics IMDS stores container metrics data. </li>
<li>The Network Metrics IMDS stores network metrics data. </li>
<li>The App Event IMDS stores app event data. </li>
</ul>

<p>To customize PCF Metrics for high capacity, you can add memory to the VMs that run these components.</p>

<h3><a id='metrics-considerations'></a> Considerations for Scaling</h3>

<p>To calculate the correct memory allocation for each IMDS component of PCF Metrics, use the following formulas:</p>

<ul>
<li><strong>Container Metrics IMDS</strong>: Each app instance produces around 500 kilobytes of metrics over a 24-hour period. To initially size this IMDS, multiply your number of app instances by 600 kilobytes. This should be your minimal setting for RAM on this IMDS. Consider over-allocating RAM to this resource to account for growth in app instances.<br></li>
<li><strong>Network Metrics IMDS</strong>: Network traffic can be difficult to assess in advance. Consider allocating 4 megabytes of RAM per app as a starting point and then evaluating the memory use on this IMDS.<br></li>
<li><strong>App Event IMDS</strong>: This resource depends on how frequently app events occur within an environment. Start by allocating 600 kilobytes per app instances and then multiply the number of expected app events over a 24-hour period by 20 bytes. As a rule of thumb, you can size this resource at 1 megabytes RAM per app instance, and then evaluate IMDS performance.<br></li>
</ul>

<p>Use these results as guidelines. Consider configuring your IMDS components with additional memory if your deployment adds additional app instances. </p>

<h3><a id='metrics-procedures'></a> Procedures for Scaling</h3>

<p class="note warning">
<strong>WARNING: </strong> If you modify the memory allocation of IMDS components, they will lose any data currently being stored.</p>

<p>After determining the amount of memory required for each IMDS component, perform the following steps:</p>

<ol>
<li>Navigate to the Ops Manager Installation Dashboard and click the <strong>Metrics</strong> tile.</li>
<li>From the <strong>Settings</strong> tab of the <strong>Metrics</strong> tile, click <strong>Resource Config</strong>.</li>
<li>Perform one or more of the following procedures, depending on which IMDS component you want to add memory to:
<img src="images/imds.png" />

<ul>
<li>To increase the memory limit for your App Event IMDS, locate the <strong>App Event Data Store</strong> job and select the dropdown menu under <strong>VM Type</strong> to select a VM with the desired amount of memory.</li>
<li>To increase the memory limit for your Network Metrics IMDS, locate the <strong>Network Metrics Data Store</strong> job and select the dropdown menu under <strong>VM Type</strong> to select a VM with the desired amount of memory. </li>
<li>To increase the memory limit for your Container Metrics IMDS, locate the <strong>Container Metrics Data Store</strong> job and select the dropdown menu under <strong>VM Type</strong> to select a VM with the desired amount of memory.</li>
</ul></li>
</ol>

<h2><a id='log-datastore'></a> Configuring the Log Datastore</h2>

<p>PCF Metrics uses the <a href="https://www.elastic.co/">Elasticsearch</a> search engine to store logs. Each Elasticsearch node contains multiple shards of log data, divided by time slice. To customize PCF Metrics for high capacity, you can scale the number of Elasticsearch nodes.</p>

<h3><a id='log-considerations'></a> Considerations for Scaling</h3>

<p>To determine the number of Elasticsearch nodes required for PCF Metrics, consider how many logs the apps in your deployment emit and the average size of each log.</p>

<p>If your average log size is 1 kilobyte, and each node has 1 terabyte of available disk space, then each node has a maximum storage capacity of 1 billion log messages. If your apps emit 3 billion logs over a 24-hour period, you need at least 3 nodes to hold the data and 3 additional nodes for high-availability replication. </p>

<p>This example assumes that your apps emit logs at a continuous rate over 24 hours. However, apps typically do not emit logs continuously. If your apps emit 2 billion of the 3 billion logs between 8 AM and 4 PM, you must determine the minimum node-to-shard ratio to accommodate that rate over the 8-hour period. Because your apps emit 1 billion logs over a 4 hour span, you need at least 6 nodes (24 hours/6 nodes = 4 hours worth of shards per node) to hold the data and an additional 6 nodes for high-availability replication.   </p>

<h3><a id='log-procedures'></a> Procedures for Scaling</h3>

<p class="note warning">
<strong>WARNING: </strong> If you modify the number of Elasticsearch instances, the Elasticsearch cluster will lose any data currently being stored.</p>

<p>After determining the number of Elasticsearch nodes needed for your deployment, perform the following steps to scale your nodes:</p>

<ol>
<li>Navigate to the Ops Manager Installation Dashboard and click the <strong>Metrics</strong> tile.</li>
<li>From the <strong>Settings</strong> tab of the <strong>Metrics</strong> tile, click <strong>Resource Config</strong>.</li>
<li>Locate the <strong>ElasticSearchData</strong> job and select the dropdown menu under <strong>Instances</strong> to change the number of instances.
<br>
<img src="images/elasticsearch.png" /></li>
<li>Click <strong>Save</strong>.<br></li>
</ol>

<h2><a id='ingestor'></a> Configuring the Ingestor</h2>

<p>PCF Metrics deploys the Ingestor as an app within PCF. The Ingestor consumes logs and metrics from the Loggregator Firehose, sending metrics to Kafka and logs to the Logqueue app. To customize PCF Metrics for high capacity, you can scale the number of Ingestor app instances and increase the amount of memory per instance.</p>

<h3><a id='ingestor-considerations'></a> Considerations for Scaling</h3>

<p>Because apps emit logs at different volumes and frequencies, you should not scale the Ingestor by matching the number of Ingestor instances to the number of app instances in your deployment.</p>

<p>Because Ingestor performance is affected by Loggregator performance, it can be difficult to determine in advance the proper configuration. Because of the ease in scaling these components, we recommend starting with a minimal configuration then evaluating performance over a period of time and scaling </p>

<p>The Ingestor app can handle relatively large loads. For high availability, you must have at least two instances of the Ingestor app running. If your deployment runs fewer than 2000 app instances, two instances of the Ingestor app are sufficient. </p>

<h3><a id='ingestor-procedures'></a> Procedures for Scaling</h3>

<p class="note warning"><strong>WARNING: </strong> If you decrease the number of Ingestor instances, you may lose data currently being processed on the instances you eliminate.</p>

<p>After determining the number of Ingestor app instances needed for your deployment, perform the following steps to scale the Ingestor:</p>

<ol>
<li><p>Target your Cloud Controller with the Cloud Foundry Command Line Interface (cf CLI). If you have not installed the cf CLI, see the <a href="http://docs.pivotal.io/pivotalcf/1-7/cf-cli/install-go-cli.html">Installing the cf CLI</a> topic.
<pre class="terminal">
$ cf api api.YOUR-SYSTEM-DOMAIN
Setting api endpoint to api.YOUR-SYSTEM-DOMAIN...
OK
API endpoint:   <span>https:</span>//api.YOUR-SYSTEM-DOMAIN (API version: 2.54.0)
Not logged in. Use &#39;cf login&#39; to log in.
</pre></p></li>
<li><p>Log in with your UAA administrator credentials. To retrieve these credentials, navigate to the <strong>Pivotal Elastic Runtime</strong> tile in the Ops Manager Installation Dashboard and click <strong>Credentials</strong>. Under <strong>UAA</strong>, click <strong>Link to Credential</strong> next to <strong>Admin Credentials</strong> and record the password.
<pre class="terminal">
$ cf login
API endpoint: <span>https:</span>//api.YOUR-SYSTEM-DOMAIN</p>

<p>Email&gt; admin
Password&gt;
Authenticating...
OK</p></li>
<li><p>When prompted, target the <code>metrics</code> space.
<pre class="terminal">
Targeted org system</p>

<p>Select a space (or press enter to skip):
<span>1</span>. system
<span>2</span>. notifications-with-ui
<span>3</span>. autoscaling
<span>4</span>. metrics</p>

<p>Space&gt; 4
Targeted space metrics</p>

<p>API endpoint:   <span>https:</span>//api.YOUR-SYSTEM-DOMAIN (API version: 2.54.0)
User:           admin
Org:            system
Space:          metrics
</pre></p></li>
<li><p>Scale your Ingestor app to the desired number of instances:
<pre class="terminal">$ cf scale metrics-ingestor -i INSTANCE-NUMBER</pre></p></li>
<li><p>Evaluate the CPU and memory load on your Ingestor instances:
<pre class="terminal">
$ cf app metrics-ingestor
Showing health and status for app metrics-ingestor in org system / space metrics as admin...
OK
<br>
requested state: started
instances: 1/1
usage: 1G x 1 instances
urls: 
last uploaded: Sat Apr 23 16:11:29 UTC 2016
stack: cflinuxfs2
buildpack: binary_buildpack 
<br><br>
     state     since                    cpu    memory        disk           details
<span>#</span>0   running   2016-07-21 03:49:58 PM   2.9%   13.5M of 1G   12.9M of 1G
</pre></p>

<p>If your average memory usage exceeds 50% or your CPU consistently averages over 85%, add more instances with <code>cf scale metrics-ingestor -i INSTANCE-NUMBER</code>.
<br><br>
In general, you should scale the Ingestor app by adding additional instances. However, you can also scale the Ingestor app by increasing the amount of memory per instance:</p>

<pre class="terminal">$ cf scale metrics-ingestor -m NEW-MEMORY-LIMIT</pre>

<p>For more information about scaling app instances, see the <a href="http://docs.pivotal.io/pivotalcf/1-7/devguide/deploy-apps/cf-scale.html">Scaling an Application Using cf scale</a> topic.</p></li>
</ol>

<h2><a id='logqueue'></a> Configuring the Logqueue</h2>

<p>PCF Metrics deploys the Logqueue as an app within PCF. The Logqueue consumes logs from the Ingestor and forwards them to the Elasticsearch nodes. To customize PCF Metrics for high capacity, you can scale the number of Logqueue app instances and increase the amount of memory per instance.</p>

<h3><a id='logqueue-considerations'></a> Considerations for Scaling</h3>

<p>To determine the number of Logqueue instances required for your deployment, multiply your number of Elasticsearch nodes by 1.5. This is a general estimate and you may need fewer instances depending on your deployment. To optimize resource allocation, provision fewer instances initially and increase instances until you achieve desired performance.</p>

<h3><a id='logqueue-procedures'></a> Procedures for Scaling</h3>

<p>To modify your Logqueue app instances, you must first target your Cloud Controller, log in with your UAA administrator credentials, and target the <code>metrics</code> space by following steps 1-3 in the <a href="#ingestor-procedures">previous section</a>.</p>

<p>To scale your Logqueue app instances, perform the following command:
<pre class="terminal">$ cf scale metrics-logqueue -i INSTANCE-NUMBER</pre></p>

<p>To scale the memory limit per Logqueue app instance, perform the following command:
<pre class="terminal">$ cf scale metrics-logqueue -m NEW-MEMORY-LIMIT</pre></p>

<p class="note warning">
<strong>WARNING: </strong> If you decrease the number of Logqueue instances, you may lose data currently being processed on the instances you eliminate.</p>

<h2><a id='troubleshooting'></a> Troubleshooting</h2>

<p>To troubleshoot PCF Metrics, review the list of common issues below. To resolve certain issues, you must check the health of your Elasticsearch cluster.</p>

<h3><a id='common-issues'></a> Common Issues</h3>

<p>The following list includes common issues and their solutions:</p>

<ul>
<li><strong>WebSocket Disconnects</strong>: If you see Websocket disconnects logs in the Ingestor app, consider adding additional Ingestor instances. The Firehose may be dropping the Ingestor connection to avoid back pressure.</li>
<li><strong>&ldquo;503&rdquo; Error</strong>: If you encounter &ldquo;503&rdquo; errors when accessing the PCF Metrics UI in your browser, your Elasticsearch nodes may have become unresponsive. Check the Elasticsearch index health by following the procedure below, and consider adding additional Elasticsearch nodes.</li>
<li><strong>Metrics/Logs Failing to Surface in UI</strong>: If you use a load balancer, the event-stream mechanism used by the Metrics UI might be blocked. 
With one customer of PCF Metrics 1.1 using a F5 load balancer, metrics and logs were not visible in the UI despite successful ingestion and no UI errors reported. 
The root of the issue was the traffic of type text/event-stream was blocked by the F5 load balancer. 
When F5 was configured to allow event-stream traffic, the issue was resolved. </li>
</ul>

<h3><a id='check-cluster-health'></a> Check Elasticsearch Cluster Health</h3>

<p>To check the health of your Elasticsearch cluster, perform the following steps:</p>

<ol>
<li>Retrieve the IP address of your Elasticsearch master node by navigating to the <strong>Metrics</strong> tile in the Ops Manager Installation Dashboard, clicking the <strong>Status</strong> tab, and recording the IP address next to <strong>ElasticSearchMaster</strong>.
<img src="images/elasticsearch-ip.png" /></li>
<li>SSH into the Ops Manager VM by following the instructions in <a href="http://docs.pivotal.io/pivotalcf/1-7/customizing/trouble-advanced.html#ssh">SSH into Ops Manager</a>.</li>
<li>From the Ops Manager VM, use <code>curl</code> to target the IP address of your Elasticsearch master node. Follow the instructions in the <a href="https://www.elastic.co/guide/en/elasticsearch/reference/2.2/_cluster_health.html">Cluster Health</a> topic of the Elasticsearch documentation.</li>
</ol>

        <div><a id='repo-link' href='http://github.com/pivotal-cf/docs-metrics/tree/1.1/sizing.html.md.erb'>View the source for this page in GitHub</a></div>

      </main>
    </div>
  </div>
</div>

<div id="scrim"></div>

<div class="container">
  <footer class="site-footer-links">
    <div class="copyright">
  <a href='https://pivotal.io/privacy-policy'>Privacy Policy</a> | 
  <a href='https://pivotal.io/terms-of-use'>Terms of Use</a><br/>
  <a href='/'>Pivotal Documentation</a>
  &copy; 2017 <a href='https://pivotal.io'>Pivotal Software</a>, Inc. All Rights Reserved.
</div>
<div class="support">
  Need help? <a href="http://support.pivotal.io" target="_blank">Visit Support</a>
</div>

  </footer>
</div><!--end of container-->

</body>
</html>
